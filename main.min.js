"use strict";class RatingCreator{constructor(){this.itemTemplate=document.querySelector("#rating-item"),this.parent=document.querySelector("#rating-list"),this.getData(this.onSuccess.bind(this),this.onError.bind(this))}messages={fail:"Не удалось получить данные"};createRating(t){console.log(t);let e=document.createDocumentFragment();t.forEach(t=>{let{table_id:s,player_id:i,phone_number:n,amount:a}=t;if(!s)return;let r=this.itemTemplate.content.cloneNode(!0);r.querySelector(".js-place .text-shadow").textContent=s,r.querySelector(".js-place .text").textContent=s,r.querySelector(".js-id").textContent=Number(i).toLocaleString("ru-RU"),r.querySelector(".js-phone").textContent=`+7 ${n.slice(1,4)} ${n.slice(4)}`,r.querySelector(".js-score").textContent=Number(a).toLocaleString("ru-RU"),e.appendChild(r)}),this.parent.appendChild(e)}onSuccess(t){let e=t.split(/\s/);e=e.filter(t=>t.length>1);let s=e[0].split(","),i=e.slice(1).map(t=>{let e={};return s.forEach((s,i)=>{e[s.trim()]=t.split(",")[i]}),e});this.createRating(i)}onError(t){console.log("error",t),this.parent.innerHTML=`<p style="color: #c74929; text-align: center">${t}</p>`}async getData(t,e){try{let s=await fetch("./data.csv");if(!s.ok)throw Error(this.messages.fail);t(await s.text())}catch(i){let n=(i instanceof TypeError&&i.message,this.messages.fail);this.onError(n)}}}class Scrollers{constructor(){this.bindEvents()}selectors={scroller:"js-scroller"};onClick(t){if(!t.target.classList.contains(this.selectors.scroller))return;let e=t.target.dataset.target;document.querySelector(`#${e}`).scrollIntoView({block:"start",behavior:"smooth"})}bindEvents(){document.addEventListener("click",t=>this.onClick(t))}}class FormHandler{constructor(){this.init()}findElements(){this.form=document.querySelector("#check-form"),this.input=this.form.querySelector("#phone"),this.inputWrapper=this.form.querySelector(".input-wrapper"),this.submit=this.form.querySelector("#check-submit"),this.result=document.querySelector("#result")}init(){this.findElements(),this.submit.setAttribute("disabled","true"),this.bindEvents()}stateClasses={active:"active",invalid:"invalid",valid:"valid",loading:"loading",filled:"filled",mistake:"vibrate"};constants={phone_length:13,country_code:"+7",operator_code:700,url:"https://1f51-92-46-46-162.ngrok-free.app/api/send-phone"};messages={fail:"Не удалось подключиться к серверу. Проверьте соединение или попробуйте позже.",error:"Произошла ошибка. Пожалуйста, попробуйте позже.",negative:"Пользователь с таким номером не найден."};switchState(t=null,e=null,s=null){(Array.isArray(t)?t:[t]).forEach(t=>{s.classList.remove(this.stateClasses[t])}),e&&s.classList.add(e)}initInput(){this.input.value.length<3&&(this.input.value=this.constants.country_code+" ")}onInputFocus(){this.switchState(["invalid","valid"],"active",this.inputWrapper),this.initInput(),this.input.selectionStart=this.constants.country_code.length+1,this.input.selectionEnd=this.input.value.length,this.submit.removeAttribute("disabled"),this.tip&&(this.tip.remove(),this.tip=null)}onInputBlur(){this.validate()?this.switchState(["invalid","active"],"valid",this.inputWrapper):(this.switchState(["active","valid"],"invalid",this.inputWrapper),this.makeTip("Не корректный номер"))}makeTip(t){this.tip=document.createElement("span"),this.tip.classList.add("tip"),this.tip.textContent=t,this.form.append(this.tip)}validate(){let t=this.input.value;return t.length===this.constants.phone_length&&parseInt(t.slice(3,6))>=this.constants.operator_code&&parseInt(t.slice(3,6))<this.constants.operator_code+100}onInputKeyDown(t){let e=t.key;e&&(!e.match(/[\d\.]|escape|enter|tab|arrow.+|delete|backspace/gi)||"Dead"==e)&&t.preventDefault()}makeResult(t,e){return e?`<output class="form-output" id="form-output" for="check-form" role="list">
      <span class="output-item" role="listitem">Ваш Player id - ${t.player_id}</span>
      <span class="output-item" role="listitem">Позиция в рейтинге: - ${t.table_id}</span>
      <span class="output-item" role="listitem">Количество очков: - ${t.amount}</span>
      </output>`:`<p class="error-message">${t}</p>`}onFormSubmit(t){if(t.preventDefault(),!this.validate()){this.inputWrapper.classList.add(this.stateClasses.mistake),this.inputWrapper.addEventListener("animationend",()=>this.inputWrapper.classList.remove("vibrate"),{once:!0});return}let e=`7${this.input.value.slice(this.constants.country_code.length+1)}`;this.form.classList.add(this.stateClasses.loading),fetch(this.constants.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e})}).then(t=>{if(!t.ok)throw Error(this.messages.error);return t.json()}).then(t=>{this.form.classList.remove(this.stateClasses.loading),this.result.innerHTML=this.makeResult(t,!0),this.result.classList.add(this.stateClasses.filled)}).catch(t=>{this.form.classList.remove(this.stateClasses.loading);let e=t instanceof TypeError&&"Failed to fetch"==t.message?this.messages.fail:this.messages.error;this.result.innerHTML=this.makeResult(e),this.result.classList.add(this.stateClasses.filled)})}bindEvents(){this.input.addEventListener("focus",this.onInputFocus.bind(this)),this.input.addEventListener("keydown",this.onInputKeyDown.bind(this)),this.input.addEventListener("input",this.initInput.bind(this)),this.input.addEventListener("blur",this.onInputBlur.bind(this)),this.form.addEventListener("submit",this.onFormSubmit.bind(this))}}window.addEventListener("load",()=>{let t=document.querySelector(".faq-list"),e=t=>{let e=t.querySelector(".panel");t.classList.remove("opened"),e.style.maxHeight="0"},s=t=>{let e=t.querySelector(".panel");t.classList.add("opened"),e.style.maxHeight=`${e.scrollHeight+60}px`},i=i=>{let n=i.target,a=t.querySelector(".opened");if(!n.classList.contains("js-toggle"))return;a&&e(a);let r=n.closest("div");r!=a&&(s(r),a=r)};t.addEventListener("click",i),new Scrollers,new RatingCreator,new FormHandler});